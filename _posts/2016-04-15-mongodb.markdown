---
layout: post
title:  "mongodb"
date:   2016-04-15 12:13:50 +0800
categories: mongodb server
---

## 复制集

### 关键概念
1. 客户端在单台服务器上可以执行的请求，都可以发送到主节点执行。
2. 客户端不能在备份节点执行写操作。
3. 默认情况下，客户端不能从备份节点读取数据。需要执行显式执行setSlaveOk.

### 初始化同步的两种方式
1. 以空数据目录启动slave服务器
2. 复制master数据目录到slave，然后启动slave服务器。（需要master停机操作）

### 注意：
* 必须使用mongo shell来配置副本集，没有其它方法可以基于文件对副本集进行配置
{% highlight js %}
//使slave可读，解决{"errmsg" : "not master and slaveOk=false", "code" : 13435 }
db.getMongo().setSlaveOk();

primaryDB.adminCommand({shutdown: 1});//关闭主服，可以用来测试故障转移
{% endhighlight %}


## 其它小知识
* 客户端连接时，如果报以下warning：
{% highlight text %}
WARNING: /sys/kernel/mm/transparent_hugepage/enabled is 'always'.
       We suggest setting it to 'never'
WARNING: /sys/kernel/mm/transparent_hugepage/defrag is 'always'.
       We suggest setting it to 'never'
{% endhighlight %}

可以通过以下方式解决：
{% highlight sh %}
# 切换到root用户
echo 'never' > /sys/kernel/mm/transparent_hugepage/enabled
echo 'never' > /sys/kernel/mm/transparent_hugepage/defrag
{% endhighlight %}

具体原理，可以参考[mongo-doc][mongo-doc]

[mongo-doc]: https://docs.mongodb.org/manual/tutorial/transparent-huge-pages/
